# Docker Compose for local development stack
# Usage: docker compose up --build
# With custom env: docker compose --env-file .env.CI up --build

# Environment variables with defaults (can be overridden via .env.CI or shell)
# WEBAPI_PORT - Port on which the WebAPI service is accessible (default: 11031)
# WEBAPP_PORT - Port on which the frontend is accessible (default: 3000)
# DATABASE_* - Database connection parameters (see .env.CI)

services:
  # SQL Server Database
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sinnet-sqlserver
    restart: unless-stopped
    ports:
      - "1433:1433"
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=P@ssw0rd123!
      - MSSQL_PID=Developer
    volumes:
      - sqlserver-data:/var/opt/mssql
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "P@ssw0rd123!" -C -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - sinnet-network

  # Dapr Placement Service
  dapr-placement:
    image: "daprio/dapr:1.12.3"
    container_name: sinnet-dapr-placement
    command: ["./placement", "-port", "50006"]
    restart: unless-stopped
    ports:
      - "50006:50006"
    networks:
      - sinnet-network

  # TimeEntries Microservice
  timeentries:
    build:
      context: ..
      dockerfile: uservice-timeentries/Dockerfile
      # BuildKit cache configuration for faster builds
      # In CI: uses GitHub Actions cache (type=gha)
      # Locally: uses inline cache embedded in image layers
      cache_from:
        - type=gha,scope=timeentries
      cache_to:
        - type=gha,scope=timeentries,mode=max
    container_name: sinnet-timeentries
    restart: unless-stopped
    depends_on:
      sqlserver:
        condition: service_healthy
      dapr-placement:
        condition: service_started
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - DATABASE_HOST=sqlserver
      - DATABASE_PORT=1433
      - DATABASE_NAME=tempdb
      - DATABASE_SCHEMA=dbo
      - DATABASE_USERNAME=sa
      - DATABASE_PASSWORD=P@ssw0rd123!
      - APP_PORT=50001
    ports:
      - "11021:8080"
    networks:
      - sinnet-network

  # Dapr sidecar for TimeEntries
  timeentries-dapr:
    image: "daprio/daprd:1.12.3"
    container_name: sinnet-timeentries-dapr
    command:
      [
        "./daprd",
        "--app-id", "uservice-timeentries",
        "--app-port", "8080",
        "--dapr-grpc-port", "50001",
        "--dapr-http-port", "3601",
        "--placement-host-address", "dapr-placement:50006",
        "--components-path", "/components",
        "--config", "/components/config.yaml"
      ]
    restart: unless-stopped
    depends_on:
      - timeentries
      - dapr-placement
    volumes:
      - ./dapr-local:/components:ro
    network_mode: "service:timeentries"

  # WebAPI GraphQL Gateway
  webapi:
    build:
      context: ..
      dockerfile: uservice-webapi/Dockerfile
      # BuildKit cache configuration for faster builds
      # Caches Maven dependencies and compiled classes
      cache_from:
        - type=gha,scope=webapi
      cache_to:
        - type=gha,scope=webapi,mode=max
    container_name: sinnet-webapi
    restart: unless-stopped
    depends_on:
      - timeentries
      - dapr-placement
    environment:
      - DAPR_GRPC_PORT=50002
    ports:
      - "${WEBAPI_PORT:-11031}:8080"
    networks:
      - sinnet-network

  # Dapr sidecar for WebAPI
  webapi-dapr:
    image: "daprio/daprd:1.12.3"
    container_name: sinnet-webapi-dapr
    command:
      [
        "./daprd",
        "--app-id", "uservice-webapi",
        "--app-port", "8080",
        "--dapr-grpc-port", "50002",
        "--dapr-http-port", "3602",
        "--placement-host-address", "dapr-placement:50006",
        "--components-path", "/components",
        "--config", "/components/config.yaml"
      ]
    restart: unless-stopped
    depends_on:
      - webapi
      - dapr-placement
    volumes:
      - ./dapr-local:/components:ro
    network_mode: "service:webapi"

  # Static Web App (React Frontend)
  static-webapp:
    build:
      context: ..
      dockerfile: static-webapp/Dockerfile
      args:
        # Frontend runs in browser, needs host-accessible URL (not container name)
        - BACKEND_BASE_URL=http://localhost:${WEBAPI_PORT:-11031}
        - APPLICATIONINSIGHTS_CONNECTION_STRING=
        - ENVIRONMENT=development
        - USE_TEST_LOGIN=true
      # BuildKit cache configuration for faster builds
      # Caches npm dependencies and compiled React assets
      cache_from:
        - type=gha,scope=webapp
      cache_to:
        - type=gha,scope=webapp,mode=max
    container_name: sinnet-webapp
    restart: unless-stopped
    depends_on:
      - webapi
    ports:
      - ${WEBAPP_PORT:-13000}:3000
    networks:
      - sinnet-network

networks:
  sinnet-network:
    driver: bridge

volumes:
  sqlserver-data:
    driver: local
