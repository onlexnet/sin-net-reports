# ============================================================================
# Docker Compose Configuration for SinNet Reports Local Development Stack
# ============================================================================
#
# USAGE:
#   Default:     docker compose up --build
#   With CI env: docker compose --env-file .env.CI up --build
#
# ENVIRONMENT VARIABLES:
#   Variables can be overridden via .env.CI file or shell environment:
#   - WEBAPI_PORT:  GraphQL API port (default: 11031)
#   - WEBAPP_PORT:  React frontend port (default: 3000)
#   - DATABASE_*:   SQL Server connection parameters (see .env.CI)
#
# BUILDKIT CACHE OPTIMIZATION:
#   This configuration uses Docker BuildKit for advanced caching:
#
#   1. GitHub Actions Cache (type=gha):
#      - Used in CI/CD pipelines running on GitHub Actions
#      - Persists cache between workflow runs (stored in GitHub)
#      - Significantly speeds up builds in CI (2-3x faster)
#      - Configured with scope names: timeentries, webapi, webapp
#      - mode=max: Exports all intermediate layers for maximum cache hits
#
#   2. Local Development:
#      - BuildKit automatically uses inline cache from image layers
#      - First build is slow (downloads dependencies, compiles code)
#      - Subsequent builds reuse cached layers (much faster)
#      - Cache is preserved in local Docker image cache
#
#   3. Dockerfile Cache Mounts (--mount=type=cache):
#      - Maven dependencies: /root/.m2 (Java services)
#      - npm packages: /root/.npm (React frontend)
#      - These caches persist across builds even when layers change
#      - Prevents re-downloading dependencies unnecessarily
#
# ============================================================================

services:
  # SQL Server Database
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sinnet-sqlserver
    restart: unless-stopped
    ports:
      - "1433:1433"
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=P@ssw0rd123!
      - MSSQL_PID=Developer
    volumes:
      - sqlserver-data:/var/opt/mssql
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "P@ssw0rd123!" -C -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - sinnet-network

  # Dapr Placement Service
  dapr-placement:
    image: "daprio/dapr:1.12.3"
    container_name: sinnet-dapr-placement
    command: ["./placement", "-port", "50006"]
    restart: unless-stopped
    ports:
      - "50006:50006"
    networks:
      - sinnet-network

  # ============================================================================
  # TimeEntries Microservice (Java Spring Boot + gRPC)
  # ============================================================================
  timeentries:
    build:
      context: ..  # Parent directory context required for api/client-java dependencies
      dockerfile: uservice-timeentries/Dockerfile
      
      # CACHE CONFIGURATION:
      # cache_from: Sources to import cache from (speeds up builds)
      #   - type=gha: GitHub Actions cache backend (only available in CI)
      #   - scope=timeentries: Unique cache namespace for this service
      # 
      # cache_to: Where to export cache for future builds
      #   - mode=max: Export all build stages and intermediate layers (best for CI)
      #   - Alternative: mode=min exports only final image (saves space but slower)
      #
      # NOTE: In local development, if GHA cache is unavailable, BuildKit
      # automatically falls back to inline cache from previously built images.
      cache_from:
        - type=gha,scope=timeentries
      cache_to:
        - type=gha,scope=timeentries,mode=max
    container_name: sinnet-timeentries
    restart: unless-stopped
    depends_on:
      sqlserver:
        condition: service_healthy
      dapr-placement:
        condition: service_started
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - DATABASE_HOST=sqlserver
      - DATABASE_PORT=1433
      - DATABASE_NAME=tempdb
      - DATABASE_SCHEMA=dbo
      - DATABASE_USERNAME=sa
      - DATABASE_PASSWORD=P@ssw0rd123!
      - APP_PORT=50001
    ports:
      - "11021:8080"
    networks:
      - sinnet-network

  # Dapr sidecar for TimeEntries
  timeentries-dapr:
    image: "daprio/daprd:1.12.3"
    container_name: sinnet-timeentries-dapr
    command:
      [
        "./daprd",
        "--app-id", "uservice-timeentries",
        "--app-port", "8080",
        "--dapr-grpc-port", "50001",
        "--dapr-http-port", "3601",
        "--placement-host-address", "dapr-placement:50006",
        "--components-path", "/components",
        "--config", "/components/config.yaml"
      ]
    restart: unless-stopped
    depends_on:
      - timeentries
      - dapr-placement
    volumes:
      - ./dapr-local:/components:ro
    network_mode: "service:timeentries"

  # ============================================================================
  # WebAPI GraphQL Gateway (Java Spring Boot + GraphQL + Dapr client)
  # ============================================================================
  webapi:
    build:
      context: ..  # Parent directory context required for api/client-java dependencies
      dockerfile: uservice-webapi/Dockerfile
      
      # CACHE CONFIGURATION:
      # Similar to timeentries service, but with its own cache scope
      # Maven dependencies (.m2 cache) are reused across builds
      # Compiled classes and JAR files are cached in intermediate layers
      cache_from:
        - type=gha,scope=webapi
      cache_to:
        - type=gha,scope=webapi,mode=max
    container_name: sinnet-webapi
    restart: unless-stopped
    depends_on:
      - timeentries
      - dapr-placement
    environment:
      - DAPR_GRPC_PORT=50002
    ports:
      - "${WEBAPI_PORT:-11031}:8080"
    networks:
      - sinnet-network

  # Dapr sidecar for WebAPI
  webapi-dapr:
    image: "daprio/daprd:1.12.3"
    container_name: sinnet-webapi-dapr
    command:
      [
        "./daprd",
        "--app-id", "uservice-webapi",
        "--app-port", "8080",
        "--dapr-grpc-port", "50002",
        "--dapr-http-port", "3602",
        "--placement-host-address", "dapr-placement:50006",
        "--components-path", "/components",
        "--config", "/components/config.yaml"
      ]
    restart: unless-stopped
    depends_on:
      - webapi
      - dapr-placement
    volumes:
      - ./dapr-local:/components:ro
    network_mode: "service:webapi"

  # ============================================================================
  # Static Web App (React Frontend with runtime configuration)
  # ============================================================================
  static-webapp:
    build:
      context: ..  # Parent directory context required for GraphQL schema from webapi
      dockerfile: static-webapp/Dockerfile
      args:
        # Build-time arguments for runtime configuration injection
        # Frontend runs in browser, needs host-accessible URL (not container name)
        - BACKEND_BASE_URL=http://localhost:${WEBAPI_PORT:-11031}
        - APPLICATIONINSIGHTS_CONNECTION_STRING=
        - ENVIRONMENT=development
        - USE_TEST_LOGIN=true
      
      # CACHE CONFIGURATION:
      # npm dependencies (.npm cache) persist across builds
      # GraphQL generated types and compiled React code are cached
      # This is the slowest build initially (npm ci + codegen + webpack)
      # Cache dramatically improves rebuild times (from ~5min to ~30sec)
      cache_from:
        - type=gha,scope=webapp
      cache_to:
        - type=gha,scope=webapp,mode=max
    container_name: sinnet-webapp
    restart: unless-stopped
    depends_on:
      - webapi
    ports:
      - ${WEBAPP_PORT:-13000}:3000
    networks:
      - sinnet-network

networks:
  sinnet-network:
    driver: bridge

volumes:
  sqlserver-data:
    driver: local
