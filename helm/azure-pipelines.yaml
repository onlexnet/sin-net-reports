
variables:
  dockerRegistryServiceConnection: "sinnet-acr"
  imageName: "uservice-customers"
  containerRegistry: "sinnetapps.azurecr.io"
  dockerRepository: onlex-sinnet-reports

trigger:
  branches:
    include:
      - master
  paths:
    include:
      - helm
pool:
  vmImage: 'ubuntu-latest'

resources:
  pipelines:
  - pipeline: webapp_CI
    project: sinnet
    source: onlex-sinnet-webapp
    trigger: true
  - pipeline: webapi_CI
    project: sinnet
    source: onlex-sinnet-webapi2
    trigger: true
  - pipeline: report_CI
    project: sinnet
    source: onlex-sinnet-reports
    trigger: true
  - pipeline: manifest_CI
    project: sinnet
    source: onlex-sinnet-manifest
    trigger: true
  containers:
    - container: webapp
      type: ACR  
      azureSubscription: sinnet-default-manual-arm
      resourceGroup: sinnet-default-manual
      registry: sinnet
      repository: webapp
    - container: webapi
      type: ACR  
      azureSubscription: sinnet-default-manual-arm
      resourceGroup: sinnet-default-manual
      registry: sinnet
      repository: webapi
    - container: reports
      type: ACR  
      azureSubscription: sinnet-default-manual-arm
      resourceGroup: sinnet-default-manual
      registry: sinnet
      repository: onlex-sinnet-reports

jobs:
  - job: CICD
    displayName: CI/CD build
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: HelmDeploy@0
      displayName: Helm package and deploy
      inputs:
        command: package
        chartPath: helm/main
        azureContainerRegistry: $(dockerRegistryServiceConnection)
    - bash: |
          echo "##vso[task.setvariable variable=WEBAPP_IMAGE_TAG]$(resources.container.webapp.tag)"
          ./makeconfig.sh
          echo 1. WEBAPP_IMAGE_TAG=$WEBAPP_IMAGE_TAG
      workingDirectory: helm/main
    - bash: |
          echo "##vso[task.setvariable variable=WEBAPP_IMAGE_TAG]$(resources.container.webapp.tag)"
          ./makeconfig.sh
          echo 2. WEBAPP_IMAGE_TAG=$WEBAPP_IMAGE_TAG
      workingDirectory: helm/main

    - task: HelmDeploy@0
      displayName: Helm deploy
      inputs:
        connectionType: Kubernetes Service Connection
        kubernetesServiceEndpoint: sinnet-microk8s
        namespace: onlex-sinnet-dev01
        command: upgrade
        install: false
        chartName: helm/main/.
        releaseName: sinnet-reports
        arguments: -f helm/main/config.yaml
