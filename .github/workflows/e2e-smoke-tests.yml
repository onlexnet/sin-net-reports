name: E2E Smoke Tests

# ============================================================================
# Workflow: Browser-based smoke tests for the complete application stack
# ============================================================================
#
# This workflow:
# 1. Builds and deploys the complete k3d/k3s stack (all services)
# 2. Starts the services in background
# 3. Runs Playwright-based E2E tests with pytest-bdd
# 4. Generates test reports and artifacts
# 5. Uploads screenshots and test results
#
# Tests are written in Gherkin (Cucumber-style BDD)
# Test execution uses Playwright for browser automation
#
# ============================================================================

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

# Limit permissions following the principle of least privilege
permissions:
  contents: read  # Read repository contents
  actions: read   # Read workflow artifacts
  checks: write   # Publish test report checks
  issues: write   # Post summary comments on pull requests

jobs:
  e2e-tests:
    name: Run E2E Smoke Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    
    steps:
      # ========================================================================
      # SETUP: Checkout and prepare environment
      # ========================================================================
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java Environment
        # Required for building Java services in Docker
        uses: ./.github/actions/setup-java-environment
        with:
          java-version: '25'
          java-distribution: 'liberica'
      
      - name: Set up Node.js 22
        # Required for building React frontend in Docker
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
          cache: 'npm'
          cache-dependency-path: static-webapp/package-lock.json
      
      - name: Set up Python 3.12
        # Required for running pytest-bdd E2E tests
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: smoke-test/e2e/requirements.txt

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Restore Docker build cache
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-e2e-buildx-${{ hashFiles('uservice-timeentries/Dockerfile', 'uservice-timeentries/**/pom.xml', 'uservice-webapi/Dockerfile', 'uservice-webapi/**/pom.xml', 'static-webapp/Dockerfile', 'static-webapp/package-lock.json', 'api/client-java/**/pom.xml', 'api/schema/**/*.proto') }}
          restore-keys: |
            ${{ runner.os }}-e2e-buildx-

      - name: Restore Playwright browser cache
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('smoke-test/e2e/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-playwright-
      
      - name: Install k3d prerequisites
        working-directory: smoke-test
        run: |
          echo "üîß Installing k3d prerequisites..."
          ./install-prerequisites.sh
          echo "‚úÖ Prerequisites installed"
      
      # ========================================================================
      # START: Launch all services in k3d
      # ========================================================================
      
      - name: Start k3d stack
        working-directory: smoke-test
        env:
          DOCKER_BUILD_CACHE_DIR: /tmp/.buildx-cache
        run: |
          echo "üöÄ Starting all services..."
          ./setup-k3d.sh up
          echo "‚úÖ Services started"
      
      - name: Wait for services to be healthy
        # Give services time to initialize and become ready
        run: |
          echo "‚è≥ Waiting for services to be healthy..."
          sleep 20
          
          echo "üìä Checking service health..."
          
          # Check TimeEntries health
          curl -f http://localhost:11021/actuator/health || echo "‚ö†Ô∏è TimeEntries not ready yet"
          
          # Check WebAPI health
          curl -f http://localhost:11031/actuator/health || echo "‚ö†Ô∏è WebAPI not ready yet"
          
          # Check Frontend
          curl -f http://localhost:3000 || echo "‚ö†Ô∏è Frontend not ready yet"
          
          echo "‚è≥ Waiting additional time for full initialization..."
          sleep 15
          
          echo "‚úÖ Services should be ready for testing"
      
      - name: Show running pods
        # Display status of all pods for debugging
        run: |
          echo "üì¶ Running pods:"
          kubectl get pods -n sinnet -o wide
      
      - name: Show service logs (last 50 lines)
        if: always()
        # Display recent logs from service pods for debugging
        run: |
          echo "üìú Recent service logs:"
          kubectl logs -n sinnet -l app=timeentries --all-containers=true --tail=50 || true
          kubectl logs -n sinnet -l app=webapi --all-containers=true --tail=50 || true
          kubectl logs -n sinnet -l app=static-webapp --all-containers=true --tail=50 || true
      
      # ========================================================================
      # TEST: Install dependencies and run E2E tests
      # ========================================================================
      
      - name: Install Python test dependencies
        working-directory: smoke-test/e2e
        # Install pytest, pytest-bdd, playwright, and other dependencies
        run: |
          echo "üì¶ Installing Python dependencies..."
          pip install -r requirements.txt
          echo "‚úÖ Dependencies installed"
      
      - name: Install Playwright browsers
        # Download Chromium browser binary for Playwright
        # Using --with-deps installs system dependencies (for Linux)
        run: |
          echo "üåê Installing Playwright browsers..."
          playwright install chromium --with-deps
          echo "‚úÖ Browser installed"
      
      - name: Run E2E smoke tests
        id: e2e_tests
        continue-on-error: true
        working-directory: smoke-test/e2e
        # Run pytest with verbose output and HTML report generation
        # Tests are defined in features/*.feature files
        # Step definitions are in step_defs/*.py files
        run: |
          echo "üß™ Running E2E smoke tests..."
          pytest -v --browser chromium \
            --html=reports/test-report.html \
            --self-contained-html \
            --junitxml=reports/junit.xml

      - name: Publish E2E test results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: E2E Tests
          path: smoke-test/e2e/reports/junit.xml
          reporter: java-junit

      - name: Build test summary markdown
        if: always()
        run: |
          python3 - <<'PY'
          import os
          import xml.etree.ElementTree as ET

          report_path = "smoke-test/e2e/reports/junit.xml"
          summary_path = "smoke-test/e2e/reports/pr-summary.md"

          tests = failures = errors = skipped = 0

          if os.path.exists(report_path):
              root = ET.parse(report_path).getroot()
              suites = [root] if root.tag == "testsuite" else root.findall("testsuite")
              for suite in suites:
                  tests += int(float(suite.attrib.get("tests", 0)))
                  failures += int(float(suite.attrib.get("failures", 0)))
                  errors += int(float(suite.attrib.get("errors", 0)))
                  skipped += int(float(suite.attrib.get("skipped", 0)))

          failed_total = failures + errors
          passed = max(tests - failed_total - skipped, 0)
          status = "‚úÖ Passed" if failed_total == 0 else "‚ùå Failed"
          run_url = f"https://github.com/{os.environ['GITHUB_REPOSITORY']}/actions/runs/{os.environ['GITHUB_RUN_ID']}"

          body = "\n".join([
              "## E2E Smoke Tests",
              "",
              f"**Status:** {status}",
              "",
              "| Metric | Count |",
              "|---|---:|",
              f"| Total | {tests} |",
              f"| Passed | {passed} |",
              f"| Failed | {failed_total} |",
              f"| Skipped | {skipped} |",
              "",
              f"Run details: {run_url}",
              "",
              "Artifacts include HTML report, screenshots (on failure), and service logs (on failure).",
          ])

          with open(summary_path, "w", encoding="utf-8") as f:
              f.write(body + "\n")
          PY

      - name: Publish test summary to job summary
        if: always()
        run: |
          if [ -f smoke-test/e2e/reports/pr-summary.md ]; then
            cat smoke-test/e2e/reports/pr-summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## E2E Smoke Tests" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "No summary generated." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upsert PR test summary comment
        if: always() && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const marker = '<!-- e2e-smoke-tests-summary -->';
            const summaryPath = 'smoke-test/e2e/reports/pr-summary.md';
            const summary = fs.existsSync(summaryPath)
              ? fs.readFileSync(summaryPath, 'utf8')
              : '## E2E Smoke Tests\n\nNo summary generated.';

            const body = `${marker}\n${summary}`;
            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find((comment) =>
              comment.user?.type === 'Bot' && comment.body?.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }
      
      # ========================================================================
      # ARTIFACTS: Upload test results and screenshots
      # ========================================================================
      
      - name: Upload test report
        if: always()
        # Upload HTML test report even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-report
          path: smoke-test/e2e/reports/
          retention-days: 30
      
      - name: Upload test screenshots
        if: failure()
        # Upload screenshots only if tests fail (for debugging)
        # Playwright automatically takes screenshots on failure
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-screenshots
          path: smoke-test/e2e/test-results/
          retention-days: 30
      
      - name: Upload service logs
        if: failure()
        # Upload Kubernetes pod logs if tests fail
        run: |
          mkdir -p smoke-test/e2e/logs
          kubectl get pods -n sinnet -o wide > smoke-test/e2e/logs/pods.txt
          kubectl logs -n sinnet -l app=timeentries --all-containers=true > smoke-test/e2e/logs/timeentries.log || true
          kubectl logs -n sinnet -l app=webapi --all-containers=true > smoke-test/e2e/logs/webapi.log || true
          kubectl logs -n sinnet -l app=static-webapp --all-containers=true > smoke-test/e2e/logs/static-webapp.log || true
          kubectl logs -n sinnet -l app=sqlserver --all-containers=true > smoke-test/e2e/logs/sqlserver.log || true
      
      - name: Upload logs artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: service-logs
          path: smoke-test/e2e/logs/
          retention-days: 30

      # ========================================================================
      # CLEANUP: Stop services and clean up
      # ========================================================================
      
      - name: Stop k3d stack
        if: always()
        working-directory: smoke-test
        # Stop and remove cluster
        run: |
          echo "üõë Stopping services..."
          ./setup-k3d.sh down
          echo "‚úÖ Services stopped"

      - name: Fail workflow if tests failed
        if: always() && steps.e2e_tests.outcome == 'failure'
        run: |
          echo "‚ùå E2E tests failed"
          exit 1
