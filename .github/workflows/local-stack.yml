name: Local Stack Build

on:
  push:
    branches: [ main, develop, local-stack-for-e2e-testing ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-stack:
    name: Build Complete Local Stack
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java Environment
        # Required for Docker builds: Maven dependencies and gRPC client generation
        # Java 25 with Liberica distribution as per project standards
        uses: ./.github/actions/setup-java-environment
        with:
          java-version: '25'
          java-distribution: 'liberica'

      - name: Set up Node.js 22
        # Required for Docker builds: npm dependencies and GraphQL codegen
        # Caches npm packages to speed up static-webapp builds
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
          cache: 'npm'
          cache-dependency-path: static-webapp/package-lock.json

      - name: Set up Docker Buildx
        # Using full commit SHA instead of v3 tag for security
        # SHA 8d2750c68a42422c14e847fe6c8ac0403b4cbd6f is the commit hash for docker/setup-buildx-action@v3
        # This enables BuildKit features including GitHub Actions cache (type=gha)
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f

      - name: Build complete stack with Docker Compose
        working-directory: smoke-test
        # Load environment variables from .env.CI file for consistent configuration
        # Docker Compose will use BuildKit cache configured in docker-compose.yml
        # Cache scopes: timeentries, webapi, webapp - speeds up rebuilds significantly
        run: docker compose --env-file .env.CI build

      - name: Verify Docker Compose configuration
        working-directory: smoke-test
        # Validates docker-compose.yml syntax and variable interpolation
        # Useful for catching configuration errors before deployment
        run: docker compose --env-file .env.CI config

      - name: Summary
        # Display build results and local development instructions
        run: |
          echo "âœ… All services built successfully!"
          echo "- TimeEntries service (Java Spring Boot + Dapr)"
          echo "- WebAPI service (GraphQL Gateway + Dapr)"
          echo "- Static WebApp (React + runtime config)"
          echo "- Docker images created with BuildKit cache"
          echo ""
          echo "To run locally: cd smoke-test && docker compose --env-file .env.CI up"
